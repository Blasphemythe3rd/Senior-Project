{% block scripts %}
<script>
    function getCookie(name) {
        let cookieValue = null;
        if (document.cookie && document.cookie !== '') {
            const cookies = document.cookie.split(';');
            for (let i = 0; i < cookies.length; i++) {
                const cookie = cookies[i].trim();
                if (cookie.substring(0, name.length + 1) === (name + '=')) {
                    cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                    break;
                }
            }
        }
        return cookieValue;
    }

    const csrftoken = getCookie('csrftoken');

 // Handle form submission for login
 document.getElementById('loginForm').addEventListener('submit', function(event) {
            event.preventDefault();
            
            let formData = new FormData(this);
            let data = {};
            formData.forEach((value, key) => {
                data[key] = value;
            });

            fetch('/PPST/admin/login/', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': csrftoken
                },
                body: JSON.stringify(data)
            })
            .then(response => {
                if (!response.ok) {
                    throw new Error('Failed to login: ' + response.statusText);
                }
                return response.json();
            })
            .then(data => {
                if (data.success) {
                    document.getElementById('loginPage').style.display = 'none';
                    document.getElementById('adminPage').style.display = 'block';
                    showTab('add');
                } else {
                    document.getElementById('loginError').textContent = data.error;
                }
            })
            .catch(error => {
                console.error('Error during login:', error);
                document.getElementById('loginError').textContent = 'An error occurred. Please try again.';
            });
        });

        // Handle Add Doctor form submission
document.getElementById('addDoctorForm').addEventListener('submit', function(event) {
    event.preventDefault();

    let formData = new FormData(this);
    let data = {};
    formData.forEach((value, key) => {
        data[key] = value;
    });

    fetch('/PPST/admin/add_doctor/', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': csrftoken // Ensuring correct CSRF token header
        },
        body: JSON.stringify(data),
        credentials: 'same-origin' // Ensuring the request includes cookies
    })
    .then(response => response.json())
    .then(data => {
        if (data.message) {
            alert('Doctor added successfully!');
            location.reload();
        } else {
            alert('Error adding doctor: ' + data.error);
        }
    })
    .catch(error => {
        console.error('Error adding doctor:', error);
        alert('An error occurred. Please try again.');
    });
});


        // Toggle between Add Doctor and List Doctors tabs
function showTab(tab) {
    // Hide all tabs
    document.getElementById('addDoctorTab').style.display = 'none';
    document.getElementById('adminTestInfoTab').style.display = 'none';
    document.getElementById('averageStatisticsTab').style.display = 'none';

    // Show the selected tab
    if (tab === 'add') {
        document.getElementById('addDoctorTab').style.display = 'block';
    } else if (tab === 'adminTestInfo') {
        document.getElementById('adminTestInfoTab').style.display = 'block';
    } else if (tab === 'average_statistics') {
        document.getElementById('averageStatisticsTab').style.display = 'block';
    }
}

// Set the default tab to "Add Doctor" when the page loads
document.addEventListener('DOMContentLoaded', function () {
    showTab('add');
});


        // Fetch tests for the selected doctor
        function fetchDoctorTests(doctorId) {
    fetch(`/PPST/admin/doctor_tests/${doctorId}/`)
        .then(response => {
            if (!response.ok) {
                throw new Error(`Failed to fetch doctor tests: ${response.statusText}`);
            }
            return response.json();
        })
        .then(data => {
            if (data.error) {
                console.error("Error:", data.error);
                alert("Error fetching doctor tests: " + data.error);
                return;
            }

            let testList = document.getElementById("testList");

            testList.innerHTML = "";

            testList.innerHTML = `<h3>Tests for Dr. ${data.doctor}</h3>`;

            if (data.tests && data.tests.length > 0) {
                let ul = document.createElement("ul");
                data.tests.forEach(test => {
                    let li = document.createElement("li");

                    const timeStarted = test.time_started ? new Date(test.time_started).toLocaleString('en-US') : 'N/A';
                    const timeEnded = test.time_ended ? new Date(test.time_ended).toLocaleString('en-US') : 'N/A';

                    li.innerHTML = `
                        <h4>Test ID: ${test.test_id}</h4>
                        <p><strong>Status:</strong> ${test.status || 'N/A'}</p>
                        <p><strong>Patient Age:</strong> ${test.patient_age || 'N/A'}</p>
                        <p><strong>Time Started:</strong> ${timeStarted}</p>
                        <p><strong>Time Ended:</strong> ${timeEnded}</p>
                    `;
                    ul.appendChild(li);
                });
                testList.appendChild(ul);
            } else {
                testList.innerHTML += "<p>No tests found.</p>";
            }
        })
        .catch(error => {
            console.error("Error fetching doctor tests:", error);
            alert("An error occurred while fetching doctor tests. Please try again.");
        });
}

document.addEventListener('DOMContentLoaded', function () {
    fetch('/PPST/admin/average_statistics/')
        .then(response => {
            if (!response.ok) {
                throw new Error('Failed to fetch average statistics: ' + response.statusText);
            }
            return response.json();
        })
        .then(data => {
            if (!data.labels || !data.values) {
                console.error('Missing data for charts:', data);
                return;
            }

            // Age Distribution Chart
            const ctx1 = document.getElementById('ageChart').getContext('2d');
            new Chart(ctx1, {
                type: 'pie',
                data: {
                    labels: data.labels,
                    datasets: [{
                        label: 'Number of Tests per Age Group',
                        data: data.values,
                        backgroundColor: [
                            'rgba(255, 99, 132, 0.6)',
                            'rgba(54, 162, 235, 0.6)',
                            'rgba(255, 206, 86, 0.6)',
                            'rgba(75, 192, 192, 0.6)',
                            'rgba(153, 102, 255, 0.6)',
                            'rgba(255, 159, 64, 0.6)',
                            'rgba(0, 200, 140, 0.6)',
                            'rgba(200, 100, 255, 0.6)'
                        ],
                        borderColor: 'rgba(75, 192, 192, 1)',
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true
                }
            });

            // Accuracy Chart
            const ctx2 = document.getElementById('accuracyChart').getContext('2d');
            new Chart(ctx2, {
                type: 'bar',
                data: {
                    labels: data.accuracy_labels,
                    datasets: [{
                        label: 'Average Accuracy (%) by Age Group',
                        data: data.accuracy_values,
                        backgroundColor: 'rgba(255, 99, 132, 0.2)',
                        borderColor: 'rgba(255, 99, 132, 1)',
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: {
                            beginAtZero: true,
                            max: 100
                        }
                    }
                }
            });

            // Stimulus Accuracy Breakdown
            const stimulusAccuracyAvg = data.stimulus_accuracy;
            const chartsContainer = document.getElementById('charts-container');
            let stimulusCounter = 1;
            let rowDiv = null;

            Object.keys(stimulusAccuracyAvg).forEach((stim_id, index) => {
                // Create a new row for every two charts
                if (index % 2 === 0) {
                    rowDiv = document.createElement('div');
                    rowDiv.classList.add('chart-row');
                    chartsContainer.appendChild(rowDiv);
                }

                const chartDiv = document.createElement('div');
                chartDiv.classList.add('chart-container');
                chartDiv.style.marginBottom = '20px';

                const header = document.createElement('h3');
                header.innerText = `Stimulus ${stimulusCounter} Accuracy by Age Group`;
                chartDiv.appendChild(header);

                stimulusCounter++;

                const canvas = document.createElement('canvas');
                canvas.width = 400; // Set fixed width
                canvas.height = 300; // Set fixed height
                chartDiv.appendChild(canvas);

                rowDiv.appendChild(chartDiv); // Append to the current row

                const accuracyData = stimulusAccuracyAvg[stim_id];
                const chartData = {
                    labels: data.labels,
                    datasets: [{
                        label: 'Accuracy (%)',
                        data: data.labels.map(age_group => accuracyData[age_group]),
                        backgroundColor: 'rgba(75, 192, 192, 0.2)',
                        borderColor: 'rgba(75, 192, 192, 1)',
                        borderWidth: 1
                    }]
                };

                const options = {
                    responsive: false, // Disable responsiveness
                    maintainAspectRatio: false, // Prevent aspect ratio enforcement
                    scales: {
                        y: {
                            beginAtZero: true,
                            min: 0, // Explicitly set the minimum value
                            max: 100, // Explicitly set the maximum value
                            ticks: {
                                stepSize: 10 // Optional: Set step size for better readability
                            }
                        }
                    }
                };

                new Chart(canvas.getContext('2d'), {
                    type: 'bar',
                    data: chartData,
                    options: options
                });
            });
        })
        .catch(error => console.error('Error fetching average statistics:', error));
});

</script>
{% endblock %}